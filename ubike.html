<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouBike 找車神器</title>

    <!-- Leaflet & Icons -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;600;800&display=swap"
        rel="stylesheet">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            start: '#F59E0B', // Amber 500
                            end: '#EA580C',   // Orange 600
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        /* 絢麗背景漸層 */
        .vibrant-bg {
            background: linear-gradient(135deg, #FFF7ED 0%, #FEF3C7 100%);
        }

        /* 玻璃擬態 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* 卡片樣式 */
        .station-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(243, 244, 246, 0.8);
            position: relative;
            overflow: hidden;
        }

        /* 卡片懸浮效果: 上浮 + 陰影加深 + 邊框發光 */
        .station-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #FCD34D;
        }

        /* 列表進場動畫 */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-entry {
            animation: slideInUp 0.5s ease-out forwards;
            opacity: 0;
            /* 預設隱藏，由動畫顯示 */
        }

        /* 滾動條美化 */
        #list-container::-webkit-scrollbar {
            width: 6px;
        }

        #list-container::-webkit-scrollbar-track {
            background: transparent;
        }

        #list-container::-webkit-scrollbar-thumb {
            background-color: #CBD5E1;
            border-radius: 20px;
        }

        /* 地圖標記優化 */
        .number-marker {
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 800;
            font-size: 15px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            /* 更深的陰影 */
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* 彈性效果 */
        }

        .number-marker:hover {
            transform: scale(1.25);
            z-index: 999 !important;
        }

        /* User Marker - 紅色光暈 */
        .user-marker {
            background: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 12px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .custom-div-icon {
            background: transparent !important;
            border: none !important;
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #F59E0B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Mobile / Desktop Layout */
        #map {
            height: 55vh;
            width: 100%;
            z-index: 10;
        }

        #list-container {
            height: 45vh;
            overflow-y: auto;
            z-index: 20;
        }

        @media (min-width: 768px) {
            #main-layout {
                flex-direction: row;
            }

            #map {
                height: 100%;
                width: 60%;
            }

            #list-container {
                height: 100%;
                width: 40%;
                box-shadow: -10px 0 15px -3px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
</head>

<body class="flex flex-col h-screen vibrant-bg">

    <!-- Navbar: 稍微降低高度 (h-14) -->
    <nav
        class="shrink-0 bg-gradient-to-r from-brand-start to-brand-end text-white p-2 shadow-lg h-14 flex justify-between items-center px-3 z-50 relative">
        <div class="font-bold text-lg md:text-xl tracking-wide flex items-center drop-shadow-md">
            <!-- 簡單的自行車 ICON -->
            <div class="bg-white/20 p-1.5 rounded-full mr-2 backdrop-blur-sm">
                <i class="fa-solid fa-bicycle text-white text-base"></i>
            </div>
            <span>轉角遇到車</span>
            <span
                class="hidden md:inline text-xs ml-2 opacity-90 font-normal bg-white/20 px-2 py-0.5 rounded-full">有Bike有保庇</span>
        </div>

        <div class="flex items-center gap-2 md:gap-3">
            <!-- 倒數計時器: 縮小字體 -->
            <div
                class="bg-black/20 text-white px-2 py-0.5 rounded-full text-[10px] md:text-xs font-mono backdrop-blur-sm border border-white/10 flex items-center">
                <i class="fa-regular fa-clock mr-1 opacity-70"></i>
                <span id="countdown">30</span>s
            </div>

            <!-- 手動定位按鈕 -->
            <button onclick="reCenterMap()" title="回到我的位置"
                class="bg-white/10 border border-white/30 text-white w-8 h-8 md:w-9 md:h-9 rounded-full shadow-sm hover:bg-white/20 hover:scale-105 active:scale-95 transition-all flex justify-center items-center backdrop-blur-md">
                <i class="fa-solid fa-location-crosshairs text-xs md:text-sm"></i>
            </button>

            <!-- 重整按鈕 -->
            <button onclick="manualRefresh()"
                class="bg-white/10 border border-white/30 text-white px-3 py-1 rounded-full text-xs md:text-sm font-bold shadow-sm hover:bg-white/20 hover:scale-105 active:scale-95 transition-all flex items-center backdrop-blur-md">
                <i class="fa-solid fa-rotate mr-1.5 md:mr-2 text-[10px] md:text-xs"></i>
                <span>重整</span>
            </button>
        </div>
    </nav>

    <!-- Error Toast -->
    <div id="error-msg"
        class="hidden absolute top-20 left-1/2 transform -translate-x-1/2 z-[2000] bg-red-500 text-white px-4 py-2 text-sm rounded-full shadow-2xl flex items-center animate-bounce whitespace-nowrap">
        <i class="fa-solid fa-circle-exclamation mr-2"></i>
        <span id="error-text" class="font-bold"></span>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="absolute inset-0 z-[3000] bg-white/90 backdrop-blur-md flex flex-col justify-center items-center">
        <div class="loader mb-6 shadow-orange-500/50 drop-shadow-lg"></div>
        <div id="loading-text" class="text-slate-700 font-bold text-lg md:text-xl tracking-widest animate-pulse">
            正在搜尋您的位置...</div>
        <div class="text-slate-400 text-xs md:text-sm mt-2">請保持 GPS 開啟以獲得最佳體驗</div>
    </div>

    <!-- Main Content -->
    <div id="main-layout" class="flex flex-col md:flex-row flex-1 relative overflow-hidden">
        <div id="map" class="shadow-inner"></div>

        <div id="list-container" class="flex flex-col bg-slate-50 relative">
            <!-- 列表標題: 縮減 padding -->
            <div class="p-3 glass-panel sticky top-0 z-30 flex-shrink-0">
                <h2 class="font-bold text-slate-800 text-base md:text-lg flex justify-between items-end">
                    <span class="flex items-center">
                        <i class="fa-solid fa-location-dot text-brand-end mr-2 text-lg animate-bounce"></i>
                        底加啦！附近有車
                    </span>
                    <span class="text-[10px] md:text-xs font-medium text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md">
                        範圍 1.5 km
                    </span>
                </h2>
            </div>

            <!-- 列表內容區 -->
            <div id="station-list" class="p-4 space-y-3 flex-1 overflow-y-auto pb-24">
                <!-- Javascript Rendered Items -->
            </div>

            <!-- 底部裝飾 (漸層遮罩) -->
            <div
                class="absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t from-slate-50 to-transparent pointer-events-none z-20">
            </div>
        </div>
    </div>

    <!-- 浮動搜尋按鈕 (預設隱藏) -->
    <div id="search-here-btn" onclick="searchCurrentArea()"
        class="hidden absolute top-20 left-1/2 transform -translate-x-1/2 z-[1000] cursor-pointer group">
        <div
            class="bg-white text-slate-700 px-4 py-2 rounded-full shadow-lg border border-slate-200 font-bold text-sm flex items-center gap-2 group-hover:bg-brand-start group-hover:text-white transition-all">
            <i class="fa-solid fa-magnifying-glass"></i>
            搜尋此區域
        </div>
    </div>

    <!-- 返回定位按鈕 (取代原本的 Manual Center，或者作為搜尋後的提示) -->
    <div id="back-to-gps-btn" onclick="returnToGPS()"
        class="hidden absolute bottom-8 left-1/2 transform -translate-x-1/2 z-[1000] cursor-pointer">
        <div
            class="bg-slate-800/90 backdrop-blur text-white px-5 py-2.5 rounded-full shadow-xl font-bold text-sm flex items-center gap-2 hover:scale-105 transition-all animate-bounce">
            <i class="fa-solid fa-location-arrow"></i>
            返回我的位置
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwhNl3bZPjO9Meo8tDuiGBbcV_Nk2qOQMWnAQ3bUKBO7sbAoSLqnxIVNHGrX91cm-pW1A/exec';

        const markerColors = [
            '#EF4444', '#F97316', '#F59E0B', '#84CC16', '#10B981',
            '#06B6D4', '#0ea5e9', '#3B82F6', '#6366F1', '#8B5CF6'
        ];

        let map, userMarker;
        let stationMarkers = [];
        let userLat, userLng;

        // 狀態管理
        let isRemoteMode = false; // 是否正在查看其他區域
        let currentSearchLat, currentSearchLng; // 目前搜尋的中心點

        let refreshTimer = null;
        let countdownTimer = null;
        let secondsLeft = 60; // 改為 60 秒
        let watchId = null;

        window.onload = function () {
            startTrackingUser();
        };

        function startTrackingUser() {
            const loading = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const errorMsg = document.getElementById('error-msg');

            // 重置錯誤訊息
            errorMsg.classList.add('hidden');

            if (navigator.geolocation) {
                // 放寬 Timeout 到 30秒，並允許 10秒內的快取
                const options = { enableHighAccuracy: true, timeout: 30000, maximumAge: 10000 };

                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const isFirstLocation = (!userLat || !userLng);
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;

                        if (isFirstLocation) {
                            loadingText.innerText = "定位成功！正在鎖定 YouBike...";
                            initMap();
                            fetchNearbyData(userLat, userLng);
                            startAutoRefresh();
                        } else {
                            updateUserMarker();
                        }
                    },
                    (error) => {
                        console.error(error);

                        // 定位失敗時的處理
                        if (!userLat) {
                            handleLocationError(error);
                        }
                    },
                    options
                );
            } else {
                showError("您的瀏覽器不支援定位功能");
                loadDefaultMap();
            }
        }

        function handleLocationError(error) {
            let msg = "無法取得位置";
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    msg = "定位權限被拒絕";
                    break;
                case error.POSITION_UNAVAILABLE:
                    msg = "無法偵測到位置 (訊號不佳)";
                    break;
                case error.TIMEOUT:
                    msg = "定位請求逾時";
                    break;
            }
            showError(msg + "，已切換至預設地圖");
            loadDefaultMap(); // ★ 關鍵：失敗時直接載入預設地圖
        }

        // 用於定位失敗時，至少讓使用者可以用地圖
        function loadDefaultMap() {
            const loading = document.getElementById('loading-overlay');
            loading.classList.add('hidden');

            // 預設座標：台南火車站 (因為使用者剛才提到台南)
            // 如果還沒初始化地圖，就初始化
            if (!map) {
                // 假裝在台南，方便使用者測試
                userLat = 22.9971;
                userLng = 120.2126;
                initMap();
                // 進入遠端模式，這樣使用者移動地圖不會怪怪的
                isRemoteMode = true;
                fetchNearbyData(userLat, userLng);
                alert("因定位失敗，已先將地圖預設在台南，您可以拖曳地圖來尋找站點！");
            }
        }

        function showError(msg) {
            const errorMsg = document.getElementById('error-msg');
            const errorText = document.getElementById('error-text');

            errorText.innerText = msg;
            errorMsg.classList.remove('hidden');

            if (!document.getElementById('retry-btn')) {
                const retryBtn = document.createElement('button');
                retryBtn.id = 'retry-btn';
                retryBtn.className = "ml-3 bg-white text-red-500 text-xs font-bold px-3 py-1 rounded-full shadow hover:bg-slate-100 transition";
                retryBtn.innerText = "重試定位";
                retryBtn.onclick = () => {
                    location.reload(); // 簡單暴力，直接重整網頁最乾淨
                };
                errorMsg.appendChild(retryBtn);
            }
        }

        function initMap() {
            if (!map) {
                map = L.map('map', { zoomControl: false }).setView([userLat, userLng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OSM'
                }).addTo(map);
                L.control.zoom({ position: 'bottomright' }).addTo(map);

                // 監聽拖曳事件 -> 顯示「搜尋此區域」
                map.on('moveend', () => {
                    // 只有當中心點距離「目前搜尋點」超過一定距離，才顯示按鈕
                    // 簡單做：只要移動就顯示，除非正在自動飛
                    const center = map.getCenter();
                    const distUser = getDistance(userLat, userLng, center.lat, center.lng);

                    // 如果距離使用者超過 500m，且不是正在 Remote Mode (或者想換地方搜)
                    if (distUser > 0.5) {
                        document.getElementById('search-here-btn').classList.remove('hidden');
                    } else {
                        // 離家很近，就不顯示搜尋鈕，自動當作是看家附近
                        document.getElementById('search-here-btn').classList.add('hidden');
                        if (isRemoteMode) returnToGPS(); // 自動歸位 (可選)
                    }
                });

            } else {
                map.setView([userLat, userLng], 15);
            }
            updateUserMarker();
        }

        function updateUserMarker() {
            if (!map) return;
            if (userMarker) map.removeLayer(userMarker);

            const userIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="user-marker"></div>`,
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });

            userMarker = L.marker([userLat, userLng], { icon: userIcon, zIndexOffset: 50 }).addTo(map);
        }

        // 搜尋目前地圖中心
        function searchCurrentArea() {
            const center = map.getCenter();
            isRemoteMode = true;
            currentSearchLat = center.lat;
            currentSearchLng = center.lng;

            fetchNearbyData(currentSearchLat, currentSearchLng);

            // UI 更新
            document.getElementById('search-here-btn').classList.add('hidden');
            document.getElementById('back-to-gps-btn').classList.remove('hidden');
        }

        // 返回 GPS 模式
        function returnToGPS() {
            isRemoteMode = false;
            map.flyTo([userLat, userLng], 15);
            fetchNearbyData(userLat, userLng);

            document.getElementById('back-to-gps-btn').classList.add('hidden');
            document.getElementById('search-here-btn').classList.add('hidden');
        }

        // 手動回到定位點 (Navbar 按鈕用)
        function reCenterMap() {
            if (map && userLat && userLng) {
                returnToGPS(); // 直接復用邏輯
            } else {
                alert("尚未取得定位資訊");
            }
        }

        // 核心查詢函式
        async function fetchNearbyData(lat, lng) {
            try {
                // 如果沒傳參數，依據模式決定查哪裡
                if (!lat || !lng) {
                    if (isRemoteMode) {
                        lat = currentSearchLat;
                        lng = currentSearchLng;
                    } else {
                        lat = userLat;
                        lng = userLng;
                    }
                }

                if (!lat || !lng) return;

                const url = `${GAS_API_URL}?lat=${lat}&lng=${lng}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const json = await response.json();

                if (json.status === 'success') {
                    // 計算距離 (永遠顯示「離使用者多遠」，還是「離搜尋中心多遠」？)
                    // 使用者需求：想知道那邊的站點。
                    // 這裡我們計算「離搜尋中心」的距離較合理，或者計算離 User 距離？
                    // 通常查詢異地，想知道的是「離那個點多遠」。
                    // 但 UI 上寫 "m"，使用者可能會誤會。
                    // 為了不混淆，我們這裡統一計算：**離「地圖中心/搜尋點」的距離**。

                    const centerLat = lat;
                    const centerLng = lng;

                    const allStations = json.data.map(s => {
                        s.distance = getDistance(centerLat, centerLng, s.lat, s.lng);
                        return s;
                    });

                    const availableStations = allStations
                        .sort((a, b) => a.distance - b.distance)
                        .filter(s => s.available > 0);

                    const top10 = availableStations.slice(0, 10);

                    renderMap(top10);
                    renderList(top10);

                    document.getElementById('loading-overlay').classList.add('hidden');
                    resetCountdown();
                }
            } catch (e) {
                console.error(e);
                if (!document.getElementById('loading-overlay').classList.contains('hidden')) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            }
        }

        function renderMap(stations) {
            stationMarkers.forEach(m => map.removeLayer(m));
            stationMarkers = [];

            stations.forEach((s, index) => {
                const color = markerColors[index % markerColors.length];
                const labelContent = s.available;

                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="number-marker" style="background-color: ${color}; width: 36px; height: 36px;">${labelContent}</div>`,
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });

                const marker = L.marker([s.lat, s.lng], { icon: icon, zIndexOffset: 1000 - index })
                    .addTo(map);

                marker.on('click', () => { map.flyTo([s.lat, s.lng], 16.5); });
                stationMarkers.push(marker);
            });
        }

        function renderList(stations) {
            const container = document.getElementById('station-list');
            container.innerHTML = '';

            if (stations.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center mt-10 text-center opacity-60">
                        <i class="fa-solid fa-map-location-dot text-6xl text-slate-300 mb-4"></i>
                        <p class="text-slate-500 font-medium">哎呀！此區域 1.5 公里內沒有車車</p>
                        <p class="text-xs text-slate-400 mt-1">試著拖曳到熱鬧一點的地方？</p>
                    </div>`;
                return;
            }

            stations.forEach((s, index) => {
                const color = markerColors[index % markerColors.length];
                const num = index + 1;
                const cleanName = s.name.replace(/YouBike2\.0_/g, '');
                const delay = index * 0.05;

                const item = document.createElement('div');
                // 調小 padding: p-3 (mobile) md:p-4 (desktop)
                item.className = "station-card flex items-center p-3 md:p-4 cursor-pointer animate-entry";
                item.style.animationDelay = `${delay}s`;

                item.innerHTML = `
                    <!-- 左側編號: 調小字體 text-lg md:text-xl -->
                    <div class="flex-shrink-0 w-6 md:w-8 text-center font-extrabold text-slate-300 text-lg md:text-xl font-mono mr-2">
                        ${num}.
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <!-- 站名: 調小字體 text-sm md:text-base -->
                            <h3 class="font-bold text-slate-800 text-sm md:text-[15px] truncate mr-2 leading-tight">${cleanName}</h3>
                        </div>
                        <div class="flex items-center gap-2 text-xs font-medium">
                            <div class="flex items-center text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md">
                                <i class="fa-solid fa-person-walking mr-1 text-slate-400"></i> 
                                ${Math.round(s.distance * 1000)}m
                            </div>
                            <div class="flex gap-1">
                                <span class="bg-yellow-50 text-yellow-700 px-1.5 py-0.5 rounded border border-yellow-100 flex items-center">
                                    <i class="fa-solid fa-bolt mr-1 text-[10px]"></i>${s.available_electric}
                                </span>
                                <span class="bg-green-50 text-green-700 px-1.5 py-0.5 rounded border border-green-100 flex items-center">
                                    <i class="fa-solid fa-bicycle mr-1 text-[10px]"></i>${s.available_general}
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- 右側泡泡: 稍微縮小 -->
                    <div class="flex-shrink-0 ml-2 md:ml-3 text-right">
                        <div class="w-10 h-10 md:w-11 md:h-11 rounded-full flex flex-col justify-center items-center text-white shadow-md transform transition group-hover:scale-110" 
                             style="background: linear-gradient(135deg, ${color}, ${adjustColor(color, -20)})">
                             <span class="text-base md:text-lg font-bold leading-none mt-0.5">${s.available}</span>
                             <span class="text-[9px] opacity-80 font-normal leading-none mb-0.5">可借</span>
                        </div>
                    </div>
                `;

                item.onclick = () => {
                    map.flyTo([s.lat, s.lng], 17);
                };

                container.appendChild(item);
            });
        }

        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            if (countdownTimer) clearInterval(countdownTimer);

            // 每 60 秒抓一次
            refreshTimer = setInterval(() => { fetchNearbyData(); }, 60000);
            resetCountdown();
            countdownTimer = setInterval(() => {
                secondsLeft--;
                if (secondsLeft < 0) secondsLeft = 60;
                document.getElementById('countdown').innerText = secondsLeft;
            }, 1000);
        }

        function resetCountdown() {
            secondsLeft = 60; // 配合設定
            document.getElementById('countdown').innerText = "60";
        }

        function manualRefresh() {
            fetchNearbyData(); // 會自動判斷 isRemoteMode
            resetCountdown();
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function adjustColor(color, amount) {
            return '#' + color.replace(/^#/, '').replace(/../g, color => ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
        }
    </script>
</body>

</html>